<!DOCTYPE html>
<html>
<head>
    <title>Find Your Council Member</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.1.0/mapbox-gl.css" rel="stylesheet" />
    <style>
        body { margin: 0; padding: 0; font-family: sans-serif; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        .popup-content {
            padding: 10px;
            border-radius: 5px;
            background-color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .popup-content strong {
            font-size: 1.1em;
            color: #2c3e50;
        }
        .popup-content img {
            max-width: 280px; /* Slightly reduced max-width */
            height: auto;
            border-radius: 4px;
            margin-top: 10px;
            border: 1px solid #ddd;
        }
        /* Style for the draggable instruction popup */
        .mapboxgl-popup-content {
            cursor: grab;
        }
        .mapboxgl-popup-content:active {
            cursor: grabbing;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.1.0/mapbox-gl.js"></script>
    <script>
        mapboxgl.accessToken = 'pk.eyJ1IjoiYWFyb25pbmJyb29rbHluIiwiYSI6ImNtOGowMmZ0dzBjMDgycnB4eWdhZW9nZ2sifQ.Z70awiKsIraT8Mfh-T_iAg';

        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/aaroninbrooklyn/cm97wvhu900km01qu4y372sfy',
            center: [-73.95, 40.65],
            zoom: 11
        });

        const geocoder = new MapboxGeocoder({
            accessToken: mapboxgl.accessToken,
            mapboxgl: mapboxgl,
            marker: false,
            placeholder: 'Search for an address'
        });

        map.addControl(geocoder);
        map.addControl(new mapboxgl.NavigationControl());

        let hoverPopup = null; // To store the hover popup instance

        map.on('load', () => {
            // Display instruction image as a popup on map load
            const instructionsImageUrl = 'https://github.com/aaroninbrooklyn/findmycouncilmember/raw/d03398cb91580f629c99d3c6d76c3d0e5c2b345b/assets/MapInstructionsImage.jpg'; // Use the raw URL

            const instructionPopup = new mapboxgl.Popup({
                closeButton: false,
                closeOnClick: false,
                anchor: 'top-right',
                offset: [20, 20]
            })
            .setLngLat(map.getCenter())
            .setHTML(`<div class="popup-content"><img src="${instructionsImageUrl}" alt="Map Instructions" style="max-width: 300px; border: 1px solid #ccc; border-radius: 5px;"></div>`)
            .addTo(map);


            // Make the instruction popup draggable
            let isDragging = false;
            let startX, startY, startLngLat;
            const popupElement = instructionPopup.getElement(); // Get the popup element

            popupElement.style.cursor = 'grab';

            popupElement.addEventListener('mousedown', (e) => {
                isDragging = true;
                startX = e.clientX;
                startY = e.clientY;
                startLngLat = instructionPopup.getLngLat();
                popupElement.style.cursor = 'grabbing';
            });

            map.on('mousemove', (e) => {
                if (!isDragging) return;
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;

                const container = map.getContainer();
                const containerRect = container.getBoundingClientRect();
                const width = containerRect.width;
                const height = containerRect.height;

                // Convert pixel movement to map coordinates, taking into account map's bounds
                const center = map.getCenter();
                const zoom = map.getZoom();
                const bearing = map.getBearing();
                const pitch = map.getPitch();

                // Project the current center point to pixel coordinates
                const centerPixel = map.project(center);

                // Calculate new pixel coordinates based on the drag offset
                const newPixel = [centerPixel.x + dx, centerPixel.y + dy];

                // Unproject the new pixel coordinates to get the new center
                const newCenter = map.unproject(newPixel);

                instructionPopup.setLngLat(newCenter);
            });

            document.addEventListener('mouseup', () => {
                if (isDragging) {
                    isDragging = false;
                    popupElement.style.cursor = 'grab';
                }
            });



            // Click on BPL Council layer
            map.on('click', 'bplcouncilmap', (e) => {
                const props = e.features[0].properties;
                const lngLat = e.lngLat;

                const branchName = props["Branch Name"] || 'Branch name unavailable';
                const councilMember = props["Council Member Name"] || 'Unavailable';
                const officeAddress = props["District Office Address"] || 'Unavailable';
                const photoUrl = props["CM Photo"] || '';

                const popupHTML = `
                    <div class="popup-content">
                        <strong>${branchName}</strong><br/><br/>
                        <strong>Represented by:</strong><br/>
                        <strong>Council Member:</strong> ${councilMember}<br/>
                        <strong>District Office Address:</strong> ${officeAddress}<br/><br/>
                        ${photoUrl ? `<img src="${photoUrl}" alt="Council Member Photo">` : ''}
                    </div>
                `;

                new mapboxgl.Popup()
                    .setLngLat(lngLat)
                    .setHTML(popupHTML)
                    .addTo(map);
            });

            map.on('mouseenter', 'bplcouncilmap', (e) => {
                map.getCanvas().style.cursor = 'pointer';
                const props = e.features[0].properties;
                const lngLat = e.lngLat;

                const branchName = props["Branch Name"] || 'Branch name unavailable';

                const popupHTML = `<div class="popup-content"><strong>${branchName}</strong></div>`;

                if (hoverPopup) {
                    hoverPopup.remove();
                }

                hoverPopup = new mapboxgl.Popup({
                    closeButton: false,
                    closeOnClick: false,
                    offset: [0, -15]
                })
                    .setLngLat(lngLat)
                    .setHTML(popupHTML)
                    .addTo(map);
            });

            map.on('mouseleave', 'bplcouncilmap', () => {
                map.getCanvas().style.cursor = '';
                if (hoverPopup) {
                    hoverPopup.remove();
                    hoverPopup = null;
                }
            });
        });

        // Optional: Keep geocoder logic as-is unless you want to show rep info there too
    </script>
</body>
</html>
